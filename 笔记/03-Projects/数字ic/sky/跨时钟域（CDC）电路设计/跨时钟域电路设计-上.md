#同步 #异步
## 同步时钟/异步时钟

### 同步时钟
数字设计中，一般认为，频率相同或频率比为整数倍、且相位相同或相位差固定的两个时钟为同步时钟。
- 同源同频同相位，此类时钟频率和相位均相同，是同步的。
-  同源同频不同相位，两个时钟同频但不同相位时，只要相位差保持固定，也可以认为是同步的
- 同源不同频但存在整数倍分频比

![[Pasted image 20220621203000.png]]
上面是对于工具来说


### 异步时钟
- 不同源
-  同源但频率比不是整数倍
-  同源虽频率比为整数倍但不满足时序要求

前面介绍同步问题时有说明，当信号从快时钟域传递到慢时钟域时，只要慢时钟域能安全采集到从快时钟域传来的信号，就不存在异步问题。但如果信号在快时钟域翻转速率过快，慢时钟域可能不会安全的采集到从快时钟域传来的信号，这也可以认为是异步问题。
一般来说，慢时钟域时序约束较为宽松，快时钟域较为严格。
如下图，快时钟域信号在慢时钟域上升沿前翻转了 2 次。此时，慢时钟域会漏掉部分数据。而且，数据的快速变化也可能导致 timing violation。


## metastable （亚稳态）产生 
- setup/hold 不满足，当setup/hold，不满足时，Q最后会输出一个稳定的值，但不确定是0还是1。ck-->Q的时间很长
![[Pasted image 20220621203700.png]]

导致的问题：
1.DFF输出端不稳定  2.比cell-library里面定义的ck-->Q的延时更长
 **靠跨时钟域处理**

## 跨时钟域 
**处理目标**
- 100%确保时间在跨时钟域时的数据完整性，数据的**值，顺序，和个数**。
- 同步过后的数据没有亚稳态现象
### 单bit CDC电路

- plus on "din" 必须足够长才能保证呗d_sync0抓住，din保持时间至少一个clk1+setup +hold  


![[Pasted image 20220621205053.png]]
举个例子
比如第二个寄存器ck--Q有最大延迟1ns 时钟clk1是500mHZ,周期是2ns ，那么d_async肯定亚稳态，但对最后一个寄存器至少还有1ns的setup要求

![[Pasted image 20220621211230.png]]
同步过来后 有两种情况 主要是由于第二个寄存器亚稳态

#### 错误单bit
![[Pasted image 20220621211628.png]]

本来一直是1 由于组合逻辑会产生毛刺，本质就是组合逻辑会产生毛刺。

![[Pasted image 20220621212255.png]]
会导致最后一个寄存器亚稳态，因为第二个ck-Q延时更大再加上logic延时，有可能就会导致第三个亚稳态。

![[Pasted image 20220621213305.png]]


怎样同步多bit电路。
![[Pasted image 20220621213700.png]]
每个bit都亚稳态，很容易出现错误。

使用guard信号同步多比特数据，vld/vld_sync是guard信号 
![[Pasted image 20220621214802.png]]
上面传递效率比较慢


把vld做同步，然后形成脉冲捕捉（cap）信号，我的data从clk0到clk1只有一个寄存器直接寄存过来的，是对vld进行delay，没有反馈信号。
![[Pasted image 20220625194240.png]]


### 跨时钟域的时序约束

**Timing约束** 

![[Pasted image 20220625200157.png]]

ck--Q是不库里面地延时 会更大。
set_max_delay -**from d_sync0 -to d_sync1**
对于高速设计，需要更仔细地约束。

如果是handshake怎么约束。

![[Pasted image 20220625201304.png]]


格雷码

![[Pasted image 20220625202811.png]]